"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("crypto"),s=require("url"),r=require("ws");function t(e){if(e&&e.__esModule)return e;var s=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var t=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(s,r,t.get?t:{enumerable:!0,get:function(){return e[r]}})}})),s.default=e,Object.freeze(s)}var a=t(e),n=t(s),o=t(r);const c={all:!1,cached:!0,children:!0,modules:!0,timings:!0,hash:!0,errors:!0,warnings:!0};class i{wsServer;httpServer;path;callbacks=[];constructor(e){this.path=`/${e.path||""}`,this.httpServer=e.server,this.wsServer=new o.Server({noServer:!0}),this.setupWsServer(),this.setupListenersClient()}setupWsServer(){this.httpServer.on("upgrade",((e,s,r)=>{if(!e.url)return;n.parse(e.url).pathname!==this.path||this.wsServer.handleUpgrade(e,s,r,(e=>{this.wsServer.emit("connection",e)}))}))}setupListenersClient(){this.wsServer.on("connection",(e=>{e.on("message",(s=>{this.callbacks.forEach((r=>{r(s.toString(),(s=>{this.sendMessage(e,s)}))}))}))}))}sendMessage(e,s){e.readyState===o.OPEN&&e.send(s)}sendBroadcast(e){this.wsServer.clients.forEach((s=>{this.sendMessage(s,e)}))}onMessage(e){this.callbacks.push(e)}}const h=(e,s)=>JSON.stringify({action:e,state:s}),u=e=>a.createHash("md5").update(e).digest("hex"),l=e=>{const s=(e=>{const s=e.moduleName||e.file;if(s)return`${s}${e.loc?`:${parseInt(e.loc)}`:""}`;return e.message.split("\n")[0]})(e);return{_name_:s,_hash_:u(s)+"."+u(e.message),...e}},d=e=>{if(!e)return e;const{hash:s,time:r,warnings:t=[],errors:a=[]}=e.toJson(c);return{hash:s,time:r,warnings:t.map(l),errors:a.map(l)}};class p{state=void 0;socketServer;constructor(e){this.socketServer=new i({server:e,path:"__webpack_hmr_sever__"}),this.answerResponse()}answerResponse(){this.socketServer.onMessage(((e,s)=>{switch(e){case"init":case"check":s(h(e,this.state))}}))}sendBroadcast(e,s){const r=h(e,s);this.socketServer.sendBroadcast(r)}reloadModules(e){const s=(e=>{const s={};return Object.keys(e).forEach((r=>{s[r]=d(e[r])})),s})(e);this.state=s,this.sendBroadcast("build",s)}refresh=()=>{this.sendBroadcast("refresh")}}var v=Object.freeze({__proto__:null});exports.Types=v,exports.createHotServer=e=>new p(e),exports.default=(e,s)=>{const r=new p(s);return e.hooks.done.tap("__webpack_hmr_sever__",(e=>{r.reloadModules({client:e})})),{refresh:r.refresh}},exports.statsToData=d;
//# sourceMappingURL=index.js.map
