"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("url"),t=require("ws");function s(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(s){if("default"!==s){var r=Object.getOwnPropertyDescriptor(e,s);Object.defineProperty(t,s,r.get?r:{enumerable:!0,get:function(){return e[s]}})}})),t.default=e,Object.freeze(t)}var r=s(e),n=s(t);class a{wsServer;httpServer;path;callbacks=[];constructor(e){this.path=`/${e.path||""}`,this.httpServer=e.server,this.wsServer=new n.Server({noServer:!0}),this.setupWsServer(),this.setupListenersClient()}setupWsServer(){this.httpServer.on("upgrade",((e,t,s)=>{if(!e.url)return;r.parse(e.url).pathname!==this.path||this.wsServer.handleUpgrade(e,t,s,(e=>{this.wsServer.emit("connection",e)}))}))}setupListenersClient(){this.wsServer.on("connection",(e=>{e.on("message",(t=>{this.callbacks.forEach((s=>{s(t.toString(),(t=>{this.sendMessage(e,t)}))}))}))}))}sendMessage(e,t){e.readyState===n.OPEN&&e.send(t)}sendBroadcast(e){this.wsServer.clients.forEach((t=>{this.sendMessage(t,e)}))}onMessage(e){this.callbacks.push(e)}}const i={all:!1,cached:!0,children:!0,modules:!0,timings:!0,hash:!0,errors:!0,warnings:!0},o=(e,t)=>{const s={action:e,data:t};return JSON.stringify(s)};class c{socketServer;putStats=(()=>{let e=null;return function(t){return void 0!==t&&(e=t),e}})();constructor(e){this.socketServer=new a({server:e,path:"__webpack_hmr_sever__"}),this.listenClinets()}listenClinets(){this.socketServer.onMessage(((e,t)=>{switch(e){case"init":case"check":t(o(e,this.getModuleData()))}}))}sendBroadcast(e,t){const s=o(e,t);this.socketServer.sendBroadcast(s)}getModuleData(e){return(e=>{if(!e)return null;try{const t=e.toJson(i),{warnings:s=[],errors:r=[]}=t;return{hash:t.hash,time:t.time,warnings:s,errors:r}}catch(e){return null}})(this.putStats(e))}processStats(e){this.sendBroadcast("build",this.getModuleData(e))}processReload(){this.sendBroadcast("reload",null)}}exports.HotModuleServer=c,exports.default=(e,t)=>{const s=new c(t);e.hooks.done.tap("__webpack_hmr_sever__",(e=>{s.processStats(e)}))},exports.manual=e=>new c(e);
//# sourceMappingURL=index.js.map
