{"version":3,"file":"index.js","sources":["../src/server/socket.ts","../src/common/constants.ts","../src/server/index.ts"],"sourcesContent":["import webpack from 'webpack';\nimport stripAnsi from 'strip-ansi';\nimport * as url from 'url';\nimport * as http from 'http';\nimport * as WebSocket from 'ws';\n\nexport interface Options {\n  server: http.Server;\n  path?: string;\n}\n\nexport interface HotModuleMessage {\n  action: 'check' | 'build';\n  stats: webpack.Stats | null;\n}\n\nexport interface ModuleData {\n  name: string;\n  hash?: string;\n  time?: number;\n  warnings: Array<webpack.StatsError>;\n  errors: Array<webpack.StatsError>;\n}\n\nconst STATS_CONFIG = {\n  all: false,\n  cached: true,\n  children: true,\n  modules: true,\n  timings: true,\n  hash: true,\n  errors: true,\n  warnings: true,\n};\n\nexport const hotModuleReplacement = (options: Options) => {\n  let lastStat: webpack.Stats | null = null;\n  const wsServer = new WebSocket.Server({ noServer: true });\n\n  options.server.on('upgrade', (request, socket, head) => {\n    if (!request.url) return;\n    const pathname = url.parse(request.url).pathname;\n    if (pathname === options.path || !options.path) {\n      wsServer.handleUpgrade(request, socket, head, (ws) => {\n        wsServer.emit('connection', ws);\n      });\n      return;\n    }\n    socket.destroy();\n  });\n\n  const sendMessage = (client: WebSocket.WebSocket, action: 'check' | 'build', data?: ModuleData): void => {\n    if (client.readyState === WebSocket.OPEN) {\n      client.send(\n        JSON.stringify({\n          action,\n          data,\n        }),\n      );\n    }\n  };\n\n  const send = (client: WebSocket.WebSocket, action: 'check' | 'build', stats: webpack.Stats | null): void => {\n    if (!stats) {\n      sendMessage(client, action);\n      return;\n    }\n\n    const statsObj = stats.toJson(STATS_CONFIG);\n\n    const errors: Array<webpack.StatsError> = statsObj.errors || [];\n    const warnings: Array<webpack.StatsError> = statsObj.warnings || [];\n\n    sendMessage(client, action, {\n      name: statsObj.name || stats.compilation.name || '',\n      time: statsObj.time,\n      hash: statsObj.hash,\n      errors: errors.map((error) => {\n        error.message = stripAnsi(error.message);\n        return error;\n      }),\n      warnings: warnings.map((warning) => {\n        warning.message = stripAnsi(warning.message);\n        return warning;\n      }),\n    });\n  };\n\n  // Synchronize stats when socket start\n  wsServer.on('connection', (client) => {\n    client.on('message', (data) => {\n      try {\n        const message = JSON.parse(data.toString());\n        if (message.action === 'check') {\n          send(client, 'check', lastStat);\n        }\n        // eslint-disable-next-line no-empty\n      } catch (e) {}\n    });\n  });\n\n  const sendStats = function (stats: webpack.Stats | null) {\n    lastStat = stats;\n\n    // broadcast messages\n    wsServer.clients.forEach((client) => {\n      send(client, 'build', lastStat);\n    });\n  };\n\n  const sendAction = function (stats: webpack.Stats | null) {\n    lastStat = stats;\n\n    // broadcast messages\n    wsServer.clients.forEach((client) => {\n      send(client, 'build', lastStat);\n    });\n  };\n\n  return sendStats;\n};\n","const name = '__webpack_hmr_sever__';\n\nexport const GLOBAL_NAME = name;\nexport const QUERY_PATH = name;\nexport const WEBPACK_PLUGIN_NAME = name;\nexport const TIMEOUT = 5000;\n","import webpack from 'webpack';\nimport * as http from 'http';\nimport { hotModuleReplacement } from './socket';\nimport { WEBPACK_PLUGIN_NAME, QUERY_PATH } from '../common/constants';\n\nexport { hotModuleReplacement };\n\nexport const webpackHmrServer = (compiler: webpack.Compiler, server: http.Server) => {\n  const sendHmr = hotModuleReplacement({\n    server: server,\n    path: `/${QUERY_PATH}`,\n  });\n  compiler.hooks.done.tap(WEBPACK_PLUGIN_NAME, (stats: webpack.Stats) => {\n    sendHmr(stats);\n  });\n};\n\nexport default webpackHmrServer;\nmodule.exports = webpackHmrServer;\n"],"names":["WebSocket","url","stripAnsi"],"mappings":"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"}